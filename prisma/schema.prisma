generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model evolucaoindividual {
  id_evolucao_individual Int                    @id @default(autoincrement())
  id_morador             Int
  id_usuario             Int
  data_hora              DateTime               @default(now())
  // Aumentado para suportar até 1000 caracteres (antes default ~191 causava P2000 em textos maiores)
  observacoes            String                 @db.VarChar(1000)
  morador                morador                @relation(fields: [id_morador], references: [id_morador], map: "EvolucaoIndividual_id_morador_fkey")
  usuario                usuario                @relation(fields: [id_usuario], references: [id_usuario], map: "EvolucaoIndividual_id_usuario_fkey")
  relatoriodiariogeral   relatoriodiariogeral[]
  // relação pivot nova para múltiplos relatórios
  relatoriosPivot        RelatorioEvolucao[]

  @@index([id_morador], map: "EvolucaoIndividual_id_morador_fkey")
  @@index([id_usuario], map: "EvolucaoIndividual_id_usuario_fkey")
}

model medicacao {
  id_medicacao              Int                   @id @default(autoincrement())
  id_usuario                Int
  id_medicamento_prescricao Int
  data_hora                 DateTime              @default(now())
  medicamentoprescricao     medicamentoprescricao @relation(fields: [id_medicamento_prescricao], references: [id_medicamento_prescricao], map: "Medicacao_id_medicamento_prescricao_fkey")
  usuario                   usuario               @relation(fields: [id_usuario], references: [id_usuario], map: "Medicacao_id_usuario_fkey")

  @@index([id_medicamento_prescricao], map: "Medicacao_id_medicamento_prescricao_fkey")
  @@index([id_usuario], map: "Medicacao_id_usuario_fkey")
}

model medicamento {
  id_medicamento        Int                     @id @default(autoincrement())
  nome_medicamento      String
  situacao              Boolean
  medicamentoprescricao medicamentoprescricao[]
}

model medicamentoprescricao {
  id_medicamento_prescricao Int         @id @default(autoincrement())
  id_medicamento            Int
  id_prescricao             Int
  posologia                 String
  id_usuario                Int?
  medicacao                 medicacao[]
  medicamento               medicamento @relation(fields: [id_medicamento], references: [id_medicamento], map: "MedicamentoPrescricao_id_medicamento_fkey")
  prescricao                prescricao  @relation(fields: [id_prescricao], references: [id_prescricao], map: "MedicamentoPrescricao_id_prescricao_fkey")
  usuario                   usuario?    @relation(fields: [id_usuario], references: [id_usuario], map: "MedicamentoPrescricao_id_usuario_fkey")

  @@index([id_medicamento], map: "MedicamentoPrescricao_id_medicamento_fkey")
  @@index([id_prescricao], map: "MedicamentoPrescricao_id_prescricao_fkey")
  @@index([id_usuario], map: "MedicamentoPrescricao_id_usuario_fkey")
}

model medico {
  id_medico     Int          @id @default(autoincrement())
  nome_completo String
  crm           String       @unique(map: "Medico_crm_key")
  situacao      Boolean
  id_usuario    Int
  usuario       usuario      @relation(fields: [id_usuario], references: [id_usuario], map: "Medico_id_usuario_fkey")
  prescricao    prescricao[]
  @@index([id_usuario], map: "Medico_id_usuario_fkey")
}

model morador {
  id_morador         Int                  @id @default(autoincrement())
  nome_completo      String
  id_usuario         Int
  data_cadastro      DateTime             @default(now())
  cpf                String               @unique(map: "Morador_cpf_key")
  rg                 String
  situacao           Boolean
  evolucaoindividual evolucaoindividual[]
  usuario            usuario              @relation(fields: [id_usuario], references: [id_usuario], map: "Morador_id_usuario_fkey")
  prescricao         prescricao[]

  @@index([id_usuario], map: "Morador_id_usuario_fkey")
}

model prescricao {
  id_prescricao         Int                     @id @default(autoincrement())
  id_morador            Int
  id_medico             Int
  mes                   String
  ano                   String
  medicamentoprescricao medicamentoprescricao[]
  medico                medico                  @relation(fields: [id_medico], references: [id_medico], map: "Prescricao_id_medico_fkey")
  morador               morador                 @relation(fields: [id_morador], references: [id_morador], map: "Prescricao_id_morador_fkey")

  @@index([id_medico], map: "Prescricao_id_medico_fkey")
  @@index([id_morador], map: "Prescricao_id_morador_fkey")
}

model relatoriodiariogeral {
  id_relatorio_diario_geral Int                @id @default(autoincrement())
  id_usuario                Int
  id_evolucao_individual    Int
  data_hora                 DateTime           @default(now())
  observacoes               String             @db.Text
  evolucaoindividual        evolucaoindividual @relation(fields: [id_evolucao_individual], references: [id_evolucao_individual], map: "RelatorioDiarioGeral_id_evolucao_individual_fkey")
  usuario                   usuario            @relation(fields: [id_usuario], references: [id_usuario], map: "RelatorioDiarioGeral_id_usuario_fkey")
  // Fase de transição: nova relação N:N via tabela pivot
  evolucoes                 RelatorioEvolucao[]

  @@index([id_evolucao_individual], map: "RelatorioDiarioGeral_id_evolucao_individual_fkey")
  @@index([id_usuario], map: "RelatorioDiarioGeral_id_usuario_fkey")
}

model usuario {
  id_usuario           Int                    @id @default(autoincrement())
  nome_usuario         String                 @unique(map: "Usuario_nome_usuario_key")
  nome_completo        String
  cpf                  String                 @unique(map: "Usuario_cpf")
  senha_hash           String
  email                String                 @unique(map: "Usuario_email_key")
  funcao               String
  situacao             Boolean
  evolucaoindividual   evolucaoindividual[]
  medicacao            medicacao[]
  medicamentoprescricao medicamentoprescricao[]
  morador              morador[]
  relatoriodiariogeral relatoriodiariogeral[]
  medico               medico[]
}

/// Tabela pivot para suportar múltiplas evoluções em um relatório diário geral.
/// Fase 1: adicionada sem remover campo id_evolucao_individual legado.
model RelatorioEvolucao {
  id_relatorio_diario_geral Int
  id_evolucao_individual    Int
  relatorio                 relatoriodiariogeral @relation(fields: [id_relatorio_diario_geral], references: [id_relatorio_diario_geral], onDelete: Cascade)
  evolucao                  evolucaoindividual   @relation(fields: [id_evolucao_individual], references: [id_evolucao_individual], onDelete: Cascade)

  @@id([id_relatorio_diario_geral, id_evolucao_individual])
  @@index([id_evolucao_individual])
}


